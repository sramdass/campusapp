<% hash = Mark.mark_columns_with_subject_ids(@section) %>
<!--
<table>
<tr>
	<th> Student Name </th>
	<% hash.each do |sub_id, col_name| %>
		<% exams_count = @section.exams.count %>
		<th colspan = " <%=exams_count%> "> <%= Subject.find(sub_id).name %> </th>
	<% end %>
</tr>
<tr>
	<th> </th>
	<% hash.each do |sub_id, col_name| %>
		<% @section.exams.each do |exam| %>
			<th> <%= exam.name %> </th>
		<% end %>
	<% end %>
</tr>
<% @section.students.order.each do |student| %>
	<tr>
	<td><%= student.name %></td>
	<% hash.each do |sub_id, col_name| %>
		<% student.marks.order('exam_id').each do |mark| %>
			<td> 
				<% if mark.send(col_name) %>
					<%=mark.send(col_name)%> 
				<% else %>
					N/A
				<% end %>
			</td>
		<% end %>
	<% end %>
	</tr>
<% end %>
</table>
-->


<div class = "subjects-marks-report">

<% hash.each do |sub_id, col_name| %>
	<table class = 'subject-marks index_table_z float-left'>
		<% exams_count = @section.exams.count %>
		<tr class = "Subject" > <th colspan = " <%=exams_count + 3 %> "> <%= Subject.find(sub_id).name %> </th> </tr>
		<tr class = "desc" >
			<th> Name </th>
			<% total = 0%>
			<% @section.exams.order('id').each do |exam| %>
				 <% max_marks = Mark.get_max_marks(@section.id, sub_id, exam.id) %>
				<th> 
					<%= exam.name %>
					<% if max_marks %>
						<% total = total + max_marks if max_marks %>
						<br><%= max_marks.to_i %>
					<% end %>
				</th>
			<% end %>
			<th>Graph</th>
			<th>Total <br> <%= total.to_i %> </th>
		</tr>
		<% @section.students.each do |student| %>
			<tr>
				<% 
				total = 0
				graph_value = ""
				%>
				<td> <%= student.name %></td>
				<% student.marks.order('exam_id').each do |mark| %>
					<% 
					if mark.send(col_name)
					  print_mark =  mark.send(col_name)
					else
					  print_mark = 0
					end 
					total = total + print_mark
					if graph_value.length == 0
					  graph_value = graph_value + "#{print_mark.to_i}"
					else
					  graph_value = graph_value +  ", #{print_mark.to_i}"
					end
					style = mark.get_style_class(sub_id) 
					%>
					<td class = "mark <%= style %>" > <%= print_mark.to_i %> </td>
				<% end %>
				<td class = "sparklines"> <%= graph_value %> </td>
				<% style = Mark.get_style_class_for_total(total, @section.id, sub_id) %>
				<td class = "total <%=style %>" > <%= total.to_i %> </td>
			</tr>
		<% end %>
	</table>
<% end %>
</div>

<div class = "total-marks-report">
	<table class = "index_table_z total-marks">
		<tr class = "desc">  
			<th>Name</th>
			<% hash.each do |sub_id, col_name| %>
				<% max_marks_total = Mark.get_max_marks_total(@section.id, sub_id) %>
				<th> <%= Subject.find(sub_id).name %> <br> <%= max_marks_total %> </th>
			<% end %>
		</tr>
		<% @section.students.each do |student| %>
			<tr>
				<td class = "name"> <%= student.name%> </td>
				<% hash.each do |sub_id, col_name| %>
					<!-- Since we cannot find the section_id from the student (student has many sections),
						we need to pass the section_id, too. -->
					<% total = Mark.total_subject_marks(student.id, @section.id, sub_id) %>
				    <% style = Mark.get_style_class_for_total(total, @section.id, sub_id) %>
					<td class = "total <%=style %>" > <%= total.to_i %> </td>					
				<% end %>
			</tr>
		<% end %>
	</table>
</div>